<!doctype html><html lang=ja><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta content="keyword 1,keyword 2,keyword 3" name=keywords><meta content="Yudai Suzuki" name=author><meta property="og:title" content="RailsをECSで動かす時のログをどうするか考える - onigra.github.io"><meta property="og:url" content="https://onigra.github.io/blog/2020/05/04/log-strategy-rails-on-ecs/"><meta property="og:description" content="Your description here"><meta property="og:type" content="website"><title>RailsをECSで動かす時のログをどうするか考える | onigra.github.io</title><script type=text/x-mathjax-config>
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script><link rel=stylesheet href=https://onigra.github.io/css/style.css><link rel="shortcut icon" href=https://onigra.github.io/favicon.ico><link rel=stylesheet href=//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin=anonymous><link rel=stylesheet href=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/github.min.css></head><section class=section><div class=container><nav class=nav><div class=nav-left><a class=nav-item href=https://onigra.github.io><h1 class="title is-4">onigra.github.io</h1></a><nav class="nav-item level is-mobile"><a class=level-item href=/about/>About</a>
<a class=level-item href=/post/>Archives</a></nav></div><div class=nav-right><nav class="nav-item level is-mobile"><a class=level-item href=https://github.com/onigra target=_blank><span class=icon><i class="fa fa-github"></i></span></a>
<a class=level-item href=https://twitter.com/onigra_ target=_blank><span class=icon><i class="fa fa-twitter"></i></span></a>
<a class=level-item href=/index.xml target=_blank><span class=icon><i class="fa fa-rss"></i></span></a></nav></div></nav></div></section><section class=section><div class=container><h1 class=title>RailsをECSで動かす時のログをどうするか考える</h1><h2 class="subtitle is-5">May 4, 2020 by Yudai Suzuki</h2><div class=content><h2 id=実験リポジトリ>実験リポジトリ</h2><ul><li><a href=https://github.com/onigra/rails_sandbox>https://github.com/onigra/rails_sandbox</a></li></ul><h2 id=制約>制約</h2><ul><li>Fargate</li><li>リバースプロキシは別の Service で動いている<ul><li>h2o, nginx など http server のログは考慮しない</li></ul></li><li>Application Server は Unicorn</li></ul><h2 id=方針>方針</h2><ul><li>Rails, Unicorn のログは全部 STDOUT に出す<ul><li>STDOUT に両方のログがまとめて出る</li></ul></li><li>Log Format は JSON<ul><li>Unicorn のログ も JSON にする</li></ul></li><li><del>ログは FireLens と fluent-bit 使っていい感じに集約する</del> ログは全部CloudWatch Logsに吐いて、その先はKinesis Firehose</li></ul><h2 id=rails-unicorn-のログは全部-stdout-に出す>Rails, Unicorn のログは全部 STDOUT に出す</h2><ul><li>環境変数 <code>RAILS_LOG_TO_STDOUT</code> を設定すれば STDOUT にログが出る<ul><li><code>config/environment/production.rb</code> にデフォルトで設定が書いてある</li></ul></li><li>Unicorn の場合、<code>RACK_ENV</code> を <code>none</code> にしておかないと <code>Rack::CommonLogger</code> が <code>use</code> されて余計なログが出ちゃうので設定しておく</li></ul><h2 id=log-format-は-json>Log Format は JSON</h2><h3 id=rails>Rails</h3><p>Rails でサクッと Log Format を JSON にする場合、 <a href=https://github.com/roidrage/lograge>lograge</a> を使うのがメジャーだが、一つ問題があり、Rack で処理されるリクエストがログに出なくなってしまう。</p><ul><li><a href=https://github.com/roidrage/lograge/issues/48>Move logging into Rack middleware</a></li></ul><p>それを回避するために、 <a href=https://github.com/rocketjob/rails_semantic_logger>rails_semantic_logger</a> を使う。</p><ul><li><a href=http://rocketjob.github.io/semantic_logger/rails.html>http://rocketjob.github.io/semantic_logger/rails.html</a></li></ul><h3 id=unicorn>Unicorn</h3><p>Unicorn の log の Formatter を変更するには、 <code>Configurator::DEFAULTS[:logger].formatter</code> をいじる。</p><ul><li><a href=https://yhbt.net/unicorn/FAQ.html>https://yhbt.net/unicorn/FAQ.html</a><ul><li><code>Why are log messages from Unicorn are unformatted when using Rails?</code> に書いてある</li></ul></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>require <span style=color:#e6db74>&#39;json&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Configurator</span><span style=color:#f92672>::</span><span style=color:#66d9ef>DEFAULTS</span><span style=color:#f92672>[</span><span style=color:#e6db74>:logger</span><span style=color:#f92672>].</span>formatter <span style=color:#f92672>=</span> proc <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>severity, timestamp, progname, msg<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>#{</span><span style=color:#66d9ef>JSON</span><span style=color:#f92672>.</span>dump(<span style=color:#e6db74>service</span>: <span style=color:#e6db74>&#39;unicorn&#39;</span>, <span style=color:#e6db74>severity</span>: severity, <span style=color:#e6db74>timestamp</span>: timestamp, <span style=color:#e6db74>progname</span>: progname, <span style=color:#e6db74>msg</span>: msg)<span style=color:#e6db74>}</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><h3 id=その他>その他</h3><ul><li>フィルターするために、ログに識別子を追加しておく<ul><li><code>"{ "service": "rails" }"</code> みたいな</li><li>rails は <code>config.log_tags</code> に設定するのが楽</li><li>unicorn は Formatter の lambda の中で設定するのが楽</li></ul></li></ul><h2 id=ログは-firelens-と-fluent-bit-使っていい感じに集約する-ログは全部cloudwatch-logsに吐いてその先はkinesis-firehose><del>ログは FireLens と fluent-bit 使っていい感じに集約する</del> ログは全部CloudWatch Logsに吐いて、その先はKinesis Firehose</h2><p>firelensの送信先をCloudWatch Logsにすれば、の複数のコンテナのログを1つのLog Streamに集約してくれるかと思ったけど、してくれなかった。<br>そういうことがしたい場合、Datadog Logsとかに送った方がいいと思う。<br>まあS3に送ってAthenaで色々やりたいみたいな用途もあるから、firelensの用途は普通にあると思う。</p><p>-> 結局、CloudWatch Logsに全部流してCW Logs -> Kinesis Firehose -> S3 &lt;- Athena が楽だと思った。
あとCW LogsからDatadogに送りたいけど無限に金がかかる。</p></div><div class=nav-left><a class=nav-item href="https://twitter.com/home?status=Rails%e3%82%92ECS%e3%81%a7%e5%8b%95%e3%81%8b%e3%81%99%e6%99%82%e3%81%ae%e3%83%ad%e3%82%b0%e3%82%92%e3%81%a9%e3%81%86%e3%81%99%e3%82%8b%e3%81%8b%e8%80%83%e3%81%88%e3%82%8b - https%3a%2f%2fonigra.github.io%2fblog%2f2020%2f05%2f04%2flog-strategy-rails-on-ecs%2f" title="Tweet this" target=_blank><span class="fa fa-twitter fa-2x"></span></a></div></div></section><section class=section><div class="container has-text-centered"><p>&copy; 2017 | <a href=https://twitter.com/onigra_ target=_blank>Onigra</a> | Powerd by <a href=https://github.com/mgjohansen/hucore target=_blank>Hucore theme</a> & <a href=http://gohugo.io target=_blank>Hugo</a></p></div></section><script src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/highlight.min.js integrity="sha256-+bhVTaRmJ/c07eV80nU8gD2cBBF0rYkf1txqXlrbvb0=" crossorigin=anonymous></script>
<script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/languages/go.min.js></script>
<script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js></script>
<script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/languages/dockerfile.min.js></script>
<script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js></script>
<script>hljs.initHighlightingOnLoad()</script><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","trackingcode","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script>