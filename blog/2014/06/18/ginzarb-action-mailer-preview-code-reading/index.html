<!doctype html><html lang=ja><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta content="keyword 1,keyword 2,keyword 3" name=keywords><meta content="Yudai Suzuki" name=author><meta property="og:title" content="Ginza.rbのRails Action Mailer Previewのコードリーディングに行ってきた #ginzarb - onigra.github.io"><meta property="og:url" content="https://onigra.github.io/blog/2014/06/18/ginzarb-action-mailer-preview-code-reading/"><meta property="og:description" content="Your description here"><meta property="og:type" content="website"><title>Ginza.rbのRails Action Mailer Previewのコードリーディングに行ってきた #ginzarb | onigra.github.io</title><script type=text/x-mathjax-config>
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script><link rel=stylesheet href=https://onigra.github.io/css/style.css><link rel="shortcut icon" href=https://onigra.github.io/favicon.ico><link rel=stylesheet href=//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin=anonymous><link rel=stylesheet href=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/github.min.css></head><section class=section><div class=container><nav class=nav><div class=nav-left><a class=nav-item href=https://onigra.github.io><h1 class="title is-4">onigra.github.io</h1></a><nav class="nav-item level is-mobile"><a class=level-item href=/about/>About</a>
<a class=level-item href=/post/>Archives</a></nav></div><div class=nav-right><nav class="nav-item level is-mobile"><a class=level-item href=https://github.com/onigra target=_blank><span class=icon><i class="fa fa-github"></i></span></a>
<a class=level-item href=https://twitter.com/onigra_ target=_blank><span class=icon><i class="fa fa-twitter"></i></span></a>
<a class=level-item href=/index.xml target=_blank><span class=icon><i class="fa fa-rss"></i></span></a></nav></div></nav></div></section><section class=section><div class=container><h1 class=title>Ginza.rbのRails Action Mailer Previewのコードリーディングに行ってきた #ginzarb</h1><h2 class="subtitle is-5">June 18, 2014 by Yudai Suzuki</h2><div class=content><p><a href="http://ginzarb.doorkeeper.jp/events/12380?utm_campaign=event_12380_8395&amp;utm_medium=email&amp;utm_source=registered_message">これ</a>に行ってきた。<br>会場を提供してくださった リクルートライフスタイル様、ありがとうございました。</p><h2 id=概要>概要</h2><h3 id=機能使い方>機能、使い方</h3><ul><li><a href=http://y-yagi.tumblr.com/post/88746017105/rails-action-mailer-previews>RailsのAction Mailer Previewsについて</a></li><li><a href=https://github.com/ginzarb/mailer_previews_sample>サンプルアプリ</a></li></ul><h3 id=読む所>読む所</h3><p><a href=https://github.com/rails/rails/blob/4-1-stable/actionmailer/lib/action_mailer/preview.rb>https://github.com/rails/rails/blob/4-1-stable/actionmailer/lib/action_mailer/preview.rb</a></p><h3 id=コードリーディングの進め方>コードリーディングの進め方</h3><p><a href=http://www.amazon.co.jp/gp/product/4774165166>パーフェクトRails</a>の著者の一人である<a href=https://twitter.com/netwillnet>Willnetさん</a>がPCをプロジェクターに映して解説しつつ読み進め、機能に詳しくてrailsのコミットログ<a href=http://y-yagi.hatenablog.com/>しょっちゅう読んでる</a><a href=https://twitter.com/y_yagi>y_yagi</a>さんが補足説明するという豪華なスタイル。それを参加者が見つつなんか言いつつという方式で進めていた。</p><h2 id=コードリーディング>コードリーディング</h2><ul><li><a href=https://github.com/rails/rails/blob/4-1-stable/actionmailer/lib/action_mailer/preview.rb>action_mailer / preview.rb</a></li></ul><p>今回のスコープだが、ここだけ読んでもピンとこない。<br>実際にアプリからpreviewを開いてログを見てみると、railtiesのmailers_controller.rbが実行されていることがわかる。<br>なので、そこと合わせて見る。</p><pre tabindex=0><code>Started GET &#34;/rails/mailers/user_mailer/mail2?part=text%2Fplain&#34; for 127.0.0.1 at 2014-06-17 19:54:00 +0900
Processing by Rails::MailersController#preview as HTML
  Parameters: {&#34;part&#34;=&gt;&#34;text/plain&#34;, &#34;path&#34;=&gt;&#34;user_mailer/mail2&#34;}
  Rendered user_mailer/mail1.html.erb (0.1ms)
  Rendered user_mailer/mail1.text.erb (0.0ms)

UserMailer#mail1: processed outbound mail in 14.1ms
  Rendered text template (0.0ms)
Completed 200 OK in 17ms (Views: 0.5ms | ActiveRecord: 0.0ms)


Started GET &#34;/rails/mailers/user_mailer/mail2?part=text%2Fhtml&#34; for 127.0.0.1 at 2014-06-17 19:54:04 +0900
Processing by Rails::MailersController#preview as HTML
  Parameters: {&#34;part&#34;=&gt;&#34;text/html&#34;, &#34;path&#34;=&gt;&#34;user_mailer/mail2&#34;}
  Rendered user_mailer/mail1.html.erb (0.1ms)
  Rendered user_mailer/mail1.text.erb (0.0ms)

UserMailer#mail1: processed outbound mail in 13.4ms
  Rendered text template (0.0ms)
Completed 200 OK in 16ms (Views: 0.3ms | ActiveRecord: 0.0ms)
</code></pre><ul><li><a href=https://github.com/rails/rails/blob/4-1-stable/railties/lib/rails/mailers_controller.rb>railties / lib / rails / mailers_controller.rb</a></li></ul><p><code>ActionMailer::Preview.all</code>は作成したpreview配下にあるファイルを全部とってきてるのがわかる。indexメソッドのテンプレートは<a href=https://github.com/rails/rails/blob/4-1-stable/railties/lib/rails/templates/rails/mailers/index.html.erb>これ</a>。</p><p>で、その後にメールのタイトルと本文をとってきて<a href=https://github.com/rails/rails/blob/4-1-stable/railties/lib/rails/templates/rails/mailers/mailer.html.erb>これ</a>に表示させてる感じ。あとはプレーンテキストかHTMLで表示するかを条件分岐してて、これをparamsからとってきてる。</p><ul><li><a href=https://github.com/rails/rails/blob/4-1-stable/railties/lib/rails/application/finisher.rb#L22-L33>railties / lib / rails / application / finisher.rb</a></li></ul><p>mailer_previewのroutingはここで追加されてて、<code>Rails.env</code>が<code>development</code>だとroutingが動的に追加されるようになってる。welcomeページと一緒。</p><h2 id=感想>感想</h2><p>Railsに詳しい人が解説しながら読み進めてるのを見るのは非常に楽くて勉強になった。ソースの難易度や規模的にも丁度良い感じだったと思う。（自分はアホなので予習しないとたぶんついていけなかったけど）またやってほしいです。</p><h2 id=余談>余談</h2><p>少し時間が余ったので、メール周りの話になった</p><h3 id=開発中のメールを飛ばして閲覧できるfake-smtp-server--α>開発中のメールを飛ばして閲覧できる（Fake SMTP Server + α）</h3><ul><li>サービス<ul><li><a href=https://mailtrap.io/>https://mailtrap.io/</a></li></ul></li><li>gem<ul><li><a href=https://github.com/fgrehm/letter_opener_web>fgrehm/letter_opener_web</a>(Rails)</li><li><a href=https://github.com/tyabe/letter_opener-web>tyabe/letter_opener-web</a>(Sinatra)<ul><li><a href=https://twitter.com/tyabe>tyabe</a>さんが、letter_opener_webがRailsベースなのが嫌でSinatraベースで作った</li><li><a href=http://qiita.com/tyabe/items/a11e01f6682e3bcbc0aa>http://qiita.com/tyabe/items/a11e01f6682e3bcbc0aa</a></li></ul></li></ul></li></ul><h3 id=メール配信サービス>メール配信サービス</h3><ul><li><a href=http://mailchimp.com/>http://mailchimp.com/</a></li><li><a href=http://sendgrid.com/>http://sendgrid.com/</a></li></ul></div><div class=nav-left><a class=nav-item href="https://twitter.com/home?status=Ginza.rb%e3%81%aeRails%20Action%20Mailer%20Preview%e3%81%ae%e3%82%b3%e3%83%bc%e3%83%89%e3%83%aa%e3%83%bc%e3%83%87%e3%82%a3%e3%83%b3%e3%82%b0%e3%81%ab%e8%a1%8c%e3%81%a3%e3%81%a6%e3%81%8d%e3%81%9f%20%23ginzarb - https%3a%2f%2fonigra.github.io%2fblog%2f2014%2f06%2f18%2fginzarb-action-mailer-preview-code-reading%2f" title="Tweet this" target=_blank><span class="fa fa-twitter fa-2x"></span></a></div></div></section><section class=section><div class="container has-text-centered"><p>&copy; 2017 | <a href=https://twitter.com/onigra_ target=_blank>Onigra</a> | Powerd by <a href=https://github.com/mgjohansen/hucore target=_blank>Hucore theme</a> & <a href=http://gohugo.io target=_blank>Hugo</a></p></div></section><script src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/highlight.min.js integrity="sha256-+bhVTaRmJ/c07eV80nU8gD2cBBF0rYkf1txqXlrbvb0=" crossorigin=anonymous></script>
<script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/languages/go.min.js></script>
<script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js></script>
<script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/languages/dockerfile.min.js></script>
<script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js></script>
<script>hljs.initHighlightingOnLoad()</script><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","trackingcode","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script>